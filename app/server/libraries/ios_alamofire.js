ðŸ“¦
8277 /agent/index.js.map
10602 /agent/index.js
âœ„
{"version":3,"file":"index.js","sourceRoot":"/private/tmp/agents/ios_alamofire/","sources":["agent/index.ts"],"names":[],"mappings":"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"}
âœ„
(() => {
    const taskDataStore = {};
    // --- HTTP Status Code Reason Phrases ---
    const httpReasonPhrases = {
        100: "Continue", 101: "Switching Protocols", 102: "Processing", 103: "Early Hints",
        200: "OK", 201: "Created", 202: "Accepted", 203: "Non-Authoritative Information",
        204: "No Content", 205: "Reset Content", 206: "Partial Content", 207: "Multi-Status",
        208: "Already Reported", 226: "IM Used",
        300: "Multiple Choices", 301: "Moved Permanently", 302: "Found", 303: "See Other",
        304: "Not Modified", 305: "Use Proxy", 307: "Temporary Redirect", 308: "Permanent Redirect",
        400: "Bad Request", 401: "Unauthorized", 402: "Payment Required", 403: "Forbidden",
        404: "Not Found", 405: "Method Not Allowed", 406: "Not Acceptable", 407: "Proxy Authentication Required",
        408: "Request Timeout", 409: "Conflict", 410: "Gone", 411: "Length Required",
        412: "Precondition Failed", 413: "Payload Too Large", 414: "URI Too Long", 415: "Unsupported Media Type",
        416: "Range Not Satisfiable", 417: "Expectation Failed", 418: "I'm a teapot",
        421: "Misdirected Request", 422: "Unprocessable Entity", 423: "Locked", 424: "Failed Dependency",
        425: "Too Early", 426: "Upgrade Required", 428: "Precondition Required", 429: "Too Many Requests",
        431: "Request Header Fields Too Large", 451: "Unavailable For Legal Reasons",
        500: "Internal Server Error", 501: "Not Implemented", 502: "Bad Gateway", 503: "Service Unavailable",
        504: "Gateway Timeout", 505: "HTTP Version Not Supported", 506: "Variant Also Negotiates",
        507: "Insufficient Storage", 508: "Loop Detected", 510: "Not Extended", 511: "Network Authentication Required"
    };
    function safeDescription(obj) {
        try {
            if (obj === null || typeof obj !== 'object')
                return obj?.toString() ?? null;
            if (obj.isKindOfClass_ && obj.isKindOfClass_(ObjC.classes.NSNull))
                return null;
            return obj.toString();
        }
        catch (e) {
            console.error("[!] Error in safeDescription:", e.message);
            return "(error getting description)";
        }
    }
    function formatHeadersToJsonStringArray(nsDict, statusCode = null, hostValue = null) {
        let outputArray = [];
        if (statusCode != null) {
            try {
                const reason = httpReasonPhrases[statusCode] || "Status";
                outputArray.push(`HTTP/1.1 ${statusCode} ${reason}`);
            }
            catch (e) {
                outputArray.push(`_ErrorAddingStatusCode: ${e.message}`);
            }
        }
        else if (hostValue) {
            try {
                const hostStr = safeDescription(hostValue);
                if (hostStr)
                    outputArray.push(`Host: ${hostStr}`);
            }
            catch (e) {
                outputArray.push(`_ErrorAddingHostHeader: ${e.message}`);
            }
        }
        if (!nsDict || (typeof nsDict.isNull === 'function' && nsDict.isNull()) || typeof nsDict.isKindOfClass_ !== 'function') {
            return JSON.stringify(outputArray);
        }
        try {
            if (!nsDict.isKindOfClass_(ObjC.classes.NSDictionary)) {
                outputArray.push(`_ErrorNotDictionary: ${nsDict.class().toString()}`);
                return JSON.stringify(outputArray);
            }
            const dict = new ObjC.Object(nsDict);
            const count = dict.count();
            if (count > 0) {
                const keys = dict.allKeys();
                for (let i = 0; i < count; i++) {
                    const key = safeDescription(keys.objectAtIndex_(i));
                    const val = safeDescription(dict.objectForKey_(keys.objectAtIndex_(i)));
                    if (key !== null)
                        outputArray.push(`${key}: ${val}`);
                }
            }
            return JSON.stringify(outputArray);
        }
        catch (e) {
            outputArray.push(`_ErrorFormattingHeaders: ${e.message}`);
            return JSON.stringify(outputArray);
        }
    }
    function formatBodyToString(nsData) {
        if (!nsData || nsData.isKindOfClass_(ObjC.classes.NSNull))
            return null;
        try {
            return nsData.bytes().readUtf8String(nsData.length());
        }
        catch (e) {
            return `[Error formatting body: ${e.message}]`;
        }
    }
    // Proceed with hook definitions
    // Frida-compile supports TS version of Interceptor.attach etc.
    const TARGET_CLASS = "Alamofire.SessionDelegate";
    const DelegateClass = ObjC.classes[TARGET_CLASS];
    if (!DelegateClass) {
        console.error(`[!] Delegate class not found: ${TARGET_CLASS}`);
        return;
    }
    const NSMutableData = ObjC.classes.NSMutableData;
    const NSHTTPURLResponse = ObjC.classes.NSHTTPURLResponse;
    const didReceiveDataSig = "- URLSession:dataTask:didReceiveData:";
    const didCompleteSig = "- URLSession:task:didCompleteWithError:";
    const didReceiveDataMethod = DelegateClass[didReceiveDataSig];
    const didCompleteMethod = DelegateClass[didCompleteSig];
    if (didReceiveDataMethod) {
        Interceptor.attach(didReceiveDataMethod.implementation, {
            onEnter(args) {
                try {
                    const dataTask = new ObjC.Object(args[3]);
                    const chunk = args[4] ? new ObjC.Object(args[4]) : null;
                    const taskId = dataTask.taskIdentifier();
                    if (!chunk || chunk.length() === 0)
                        return;
                    if (!taskDataStore[taskId]) {
                        taskDataStore[taskId] = {
                            responseBody: NSMutableData.alloc().init()
                        };
                        const request = dataTask.originalRequest() || dataTask.currentRequest();
                        if (request) {
                            const url = request.URL();
                            const headersOriginal = request.allHTTPHeaderFields();
                            const body = request.HTTPBody();
                            let headersCopy = null;
                            try {
                                headersCopy = headersOriginal?.copy?.();
                            }
                            catch (e) {
                                console.error(`[!] Error copying headers: ${e.message}`);
                            }
                            taskDataStore[taskId].request = {
                                method: safeDescription(request.HTTPMethod()) ?? undefined,
                                // host: safeDescription(url?.host?.()) ?? undefined,
                                host: (() => {
                                    const host = safeDescription(url?.host?.());
                                    const port = safeDescription(url?.port?.());
                                    if (host && port && port !== "null" && port !== "0") {
                                        return `${host}:${port}`;
                                    }
                                    return host ?? undefined;
                                })(),
                                protocol: safeDescription(url?.scheme?.()) ?? undefined,
                                endpoint: safeDescription(url?.path?.()) ?? undefined,
                                request_headers_raw: headersCopy,
                                request_body_raw: body
                            };
                        }
                    }
                    taskDataStore[taskId].responseBody.appendData_(chunk);
                }
                catch (e) {
                    console.error(`[!] didReceiveData error: ${e.message}`);
                }
            }
        });
    }
    if (didCompleteMethod) {
        Interceptor.attach(didCompleteMethod.implementation, {
            onEnter(args) {
                try {
                    const task = new ObjC.Object(args[3]);
                    const taskId = task.taskIdentifier();
                    const errorPtr = args[4];
                    const stored = taskDataStore[taskId];
                    if (!stored || !stored.request)
                        return;
                    let statusCode = null;
                    let responseHeadersRaw = null;
                    let errorMessage = stored.script_error;
                    if (errorPtr && !errorPtr.isNull()) {
                        const errorObj = new ObjC.Object(errorPtr);
                        errorMessage = safeDescription(errorObj.localizedDescription()) || "Network error";
                    }
                    const response = task.response();
                    if (response && !response.isNull()) {
                        const responseObj = new ObjC.Object(response);
                        if (responseObj.isKindOfClass_(NSHTTPURLResponse)) {
                            statusCode = responseObj.statusCode();
                            responseHeadersRaw = responseObj.allHeaderFields();
                        }
                    }
                    else if (!errorMessage) {
                        errorMessage = "No response or error";
                        statusCode = -2;
                    }
                    const payload = {
                        method: stored.request.method,
                        host: stored.request.host,
                        protocol: stored.request.protocol,
                        endpoint: stored.request.endpoint,
                        status_code: statusCode,
                        request_headers: formatHeadersToJsonStringArray(stored.request.request_headers_raw, null, stored.request.host),
                        response_headers: formatHeadersToJsonStringArray(responseHeadersRaw, statusCode, null),
                        request_body: formatBodyToString(stored.request.request_body_raw),
                        response_body: formatBodyToString(stored.responseBody)
                    };
                    if (errorMessage) {
                        console.log(`[*] Task ${taskId}: Warning/Error: ${errorMessage}`);
                        console.log(JSON.stringify({ type: "error", taskId, message: errorMessage }));
                    }
                    send(JSON.stringify(payload));
                }
                catch (e) {
                    console.error(`[!] didComplete error: ${e.message}`);
                }
            }
        });
    }
})();